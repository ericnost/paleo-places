<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/normalize.min.css">
        <link rel="stylesheet" href="css/main.css">

        <script src="js/vendor/modernizr-2.8.3.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        

        <div id="contains-all">

        <div id="legend" class="hidden">
        </div>


        <div id="top-vertical">

        </div><!-- #top-vertical -->

        <div id="bottom-vertical">

        <div id="bottom-left">

        <div id="leaflet-map">
        </div>


        </div><!-- #bottom-left -->


        <div id="bottom-right">
        </div><!-- #bottom-right -->

        </div><!-- #bottom-vertical -->


        </div><!-- #contains-all -->






        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

        <script src="//d3js.org/d3.v3.min.js"></script>

        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>

        <script>


// Leaflet functions


var markerFlag = false;

var sitesData = "";

var mapOptions = {
  center: [36.10237644873644, -97.822265625],
  zoom: 2,
  minZoom: 2,
}

var leafletMap = new L.map('leaflet-map', mapOptions);
leafletMap.zoomControl.setPosition('bottomleft');

var tileUrl = 'http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg',
    tiles = new L.TileLayer(tileUrl);

leafletMap.addLayer(tiles);

var markers = new L.layerGroup().addTo(leafletMap);

leafletMap.on("click", mapClicked );

var defaultMarker = [43.0667, -89.4]

var timestamp = 30000

mapClicked({"latlng": {"lat": defaultMarker[0], "lng": defaultMarker[1]}})


function mapClicked(d) {

    markerFlag = true;

    var chosenSite = d.latlng; // This will get fed to output function

    markers.clearLayers();
    var marker = new L.marker(chosenSite).addTo(markers);
    leafletMap.setView(chosenSite,6);

    //function here to turn lat long into bounding box
    var longitudeWest = chosenSite.lng-2, latitudeSouth = chosenSite.lat-2, longitudeEast = chosenSite.lng+2, latitudeNorth = chosenSite.lat+2;
    var loc = longitudeWest+","+latitudeSouth+","+longitudeEast+","+latitudeNorth;

    var url = "http://api.neotomadb.org/v1/data/sites?loc=" + loc;

    // getAPI(loc);

  jsonp(url, function(data) {

  sitesData = data;
  interpolation(data);
});

}


function jsonp(url, callback) {
    var callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
    window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(data);
    };

    var script = document.createElement('script');
    script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
    document.body.appendChild(script);
}






// Time selector functions
//      Ripped off from https://bl.ocks.org/mbostock/6452972



var sliderHolder = d3.select('#bottom-right');

var sliderMargin = {top: 5, right: 50, bottom: 5, left: 50},
    sliderWidth = sliderHolder.node().getBoundingClientRect().width - ( 2 * sliderMargin.right ),
    sliderHeight = sliderHolder.node().getBoundingClientRect().height - ( 2 * sliderMargin.top );

var x = d3.scale.linear()
    .domain([-30000, 0])
    .range([0, sliderWidth])
    .clamp(true);

var brush = d3.svg.brush()
    .x(x)
    .extent([0, 0])
    .on("brush", brushed)
    .on("brushend", brushend);

var svg = sliderHolder.append("svg")
    .attr("width", sliderWidth + sliderMargin.left + sliderMargin.right)
    .attr("height", sliderHeight/2 + sliderMargin.top + sliderMargin.bottom)
    .attr("class","time-slider")
    .append("g")
    .attr("transform", "translate(" + sliderMargin.left + "," + sliderMargin.top + ")");

svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + sliderHeight / 4 + ")")
    .call(d3.svg.axis()
      .scale(x)
      .orient("bottom")
      .tickFormat(function(d) { return Math.abs(d) + " ybp"; })
      .tickSize(0)
      .tickPadding(12))
  .select(".domain")
  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "halo");

var slider = svg.append("g")
    .attr("class", "slider")
    .call(brush);

slider.selectAll(".extent,.resize")
    .remove();

slider.select(".background")
    .attr("height", sliderHeight);

var handle = slider.append("circle")
    .attr("class", "handle")
    .attr("transform", "translate(0," + sliderHeight / 4 + ")")
    .attr("r", 9);

slider
    .call(brush.extent([-12000, -12000]))
    .call(brush.event);


function brushed() {
  var value = brush.extent()[0];

  if (d3.event.sourceEvent) { // not a programmatic event
    value = x.invert(d3.mouse(this)[0]);
    brush.extent([value, value]);
  }

  handle.attr("cx", x(value));
}

function brushend() {

    timestamp = Math.abs(brush.extent()[0]); // set timestamp for interpolation


    interpolation(sitesData);

}

var placeHolder = d3.select('#bottom-right');

var placeWidth = placeHolder.node().getBoundingClientRect().width - ( 2 * sliderMargin.right ),
    placeHeight = placeHolder.node().getBoundingClientRect().height - ( 2 * sliderMargin.top );

placeHolder.append("div").attr('id', 'title').html("<span id='titleFont'>PaleoPlaces</span><br><span id='subtitleFont'>A tool for visualizing past ecological communities in the places that matter to you<p></span>")
placeHolder.append("div").attr('id', 'title').html("<span><a href='' target='_blank'>About</span>")

//Welcome transitions
d3.select('body').append('div').attr('id', 'welcome')
d3.select('#welcome').append('div').attr('id', 'welcomeText')
    .text("Welcome to PaleoPlaces")
    .transition()
    .duration(2500)
    .remove()
 d3.select('#welcome')    
    .transition()
    .duration(1500)
    .remove()
    .each("end", function(d){
        intros()
    })
function intros(){
    var timing = 4000
    d3.select('body').append('div').attr({'class': 'pick', 'id': 'map'})
        .text("First, pick a place you want to learn about.")
        .transition()
        .duration(timing)
        .remove()
        .each("end", function(d){
            d3.select('#map')    
                .transition()
                .duration(timing)
                .remove()
            d3.select('body').append('div').attr({'class': 'pick', 'id': 'time'})
                .text("Then, pick a time period you're interested in.")
                .transition()
                .duration(timing)
                .remove()
                .each("end", function(d){
                    d3.select('#time')    
                        .transition()
                        .duration(timing)
                        .remove()
                        d3.select('body').append('div').attr({'class': 'pick', 'id': 'canvas'})
                            .text("Then, up here, you'll see what the place might have looked like.")
                            .transition()
                            .duration(timing)
                            .remove()
                            .each("end", function(d){
                                d3.select('#canvas')    
                                    .transition()
                                    .duration(timing)
                                    .remove()
                                d3.select('body').append('div').attr({'class': 'pick', 'id': 'dynamic'})
                                    .text("Finally, you can go back and explore how the place changed over time by moving the slider. You can also pick a new place.")
                                    .transition()
                                    .duration(timing)
                                    .remove()
                            })
                })
        })
}


function interpolation(sitedata){
  var years = [timestamp-500, timestamp+500] //create time rnage from slider

  d3.csv("data/all_pollen_final.csv", function(pollendata) { //load our pollen file
    pollendata.forEach(function(d){
    d.Latitude=+d.Latitude
    d.Age =+ d.Age
    d.Pct =+ d.Pct
    });
   
    var sitekeys = sitedata.data.map(function(d){return d.LatitudeNorth});
    var pollenSites = pollendata.filter(function(d){return sitekeys.includes(d.Latitude)}).filter(function(d){return d.Age > years[0] && d.Age < years[1]});

     //filter our sites by whether they match results from neotoma and the year range

    var pollenNest = d3.nest() //nest data by taxon
        .key(function(d) { return d.Taxon})
        .map(pollenSites);

    var taxKeys = d3.keys(pollenNest)
    var dump = []
    for (n=0; n<taxKeys.length; n++){
        mean = d3.mean(pollenNest[taxKeys[n]], function(d){return d.Pct}); //average pollen percent (abundance) across sites

        var t = { "taxon": taxKeys[n], "distribution": mean };
        dump.push(t);
        // dump[taxKeys[n]] = mean;
    }

    drawLandscape(dump);
    //call drawing function with dump
  });
  
}









// Canvas drawing function

var landscapeHolder = d3.select("#top-vertical"),
    landscapeWidth = landscapeHolder.node().getBoundingClientRect().width,
    landscapeHeight = landscapeHolder.node().getBoundingClientRect().height,
    landscapeArea = landscapeWidth * landscapeHeight;


var landscape = landscapeHolder.append("canvas")
    .attr("width", landscapeWidth)
    .attr("height", landscapeHeight);

var context = landscape.node().getContext("2d");

var img = new Image();
img.src = 'img/oak.png';


var iconLibrary = {
    "QUERCUS" : "oak.png",
    "TSUGAX" : "hemlock.png",
    "ALNUS" : "alder.png",
    "POPULUS" : "aspen.png",
    "ASTERX" : "aster_lateriflorus.png",
    "BETULA" : "birch.png",
    "POACEAE" : "grass.png",
    "ACER" : "maple.png",
    "PINUSX" : "pine.png",
    "CYPERACE" : "sedge.png",
    "SELAGINE": "spikemoss.png",
    "PICEAX" : "spruce.png"
};



function drawLandscape(species) {

    context.clearRect(0,0,landscapeWidth,landscapeHeight);
    species.forEach( scatterIcons );

            function scatterIcons(s) {

                var taxon = s.taxon;
               
                if(iconLibrary[taxon]) {

                    var img = new Image();

                    img.addEventListener("load", function() {

                    var freq = ( s.distribution / 100 ) ;

                    var n = Math.ceil( landscapeArea / (40*40) * freq );


                    for(i=0;i<n;i++) {
                        var posX = Math.floor( Math.random() * landscapeWidth);
                        var posY = Math.floor( Math.random() * landscapeHeight);
                        context.drawImage(img, posX, posY);
                        console.log(img);
                        console.log(posX);
                    }

                    }, false);

                    img.src = 'img/' + iconLibrary[taxon];


                    

                 } 
            }

    legend(species);

}


function legend(species){

    var leg = d3.select('#legend');

    leg.html('');
    leg.classed('hidden',false);
    leg.append("text").html("<span>At this time and place, you may have found these plants:<br></span>")

    var width = 100,
        height = 100,
        radius = Math.min(width, height) / 2;

    var color = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

    var arc = d3.svg.arc()
        .outerRadius(radius - 10)
        .innerRadius(0);

    var labelArc = d3.svg.arc()
        .outerRadius(radius - 40)
        .innerRadius(radius - 40);

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) { return d.distribution; });

    var piesvg = d3.select("#legend").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    var g = piesvg.selectAll(".arc")
          .data(pie(species))
        .enter().append("g")
          .attr("class", "arc");

      g.append("path")
          .attr("d", arc)
          .style("fill", function(d) { return color(d.data.taxon); });

  var pielegend = d3.select("#legend").append("svg")
        .attr("width", 100)
        .attr("height", 100)
    pielegend.selectAll('rect')
      .data(species).enter()
      .append('rect')
      .attr("x", 0)
      .attr('y', function(d,i){return i*10})
      .attr("width", 10).attr("height", 10)
      .style("fill", function(d) {
          return color(d.taxon);
      })
    pielegend.selectAll('text')
      .data(species).enter()
      .append('text')
      .attr("x", 15)
      .attr('y', function(d,i){return i*10+10})
      .text(function(d) {
          return d.taxon;
      })
      .attr("class","pie-legend");
}






        </script>


    </body>
</html>
